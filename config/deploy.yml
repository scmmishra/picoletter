# Kamal deployment configuration for Picoletter
# See https://kamal-deploy.org for documentation

service: picoletter
image: picoletter

# Local registry (no external registry needed)
registry:
  server: localhost:5555

# Environment variables injected into containers
# Secrets come from .kamal/secrets.<destination>
env:
  secret:
    # Core
    - SECRET_KEY_BASE
    - DB_PASSWORD
    - QUEUE_DB_PASSWORD
    # Cloudflare R2
    - R2__ACCESS_KEY
    - R2__ACCESS_SECRET
    - R2__BUCKET_NAME
    - R2__ACCOUNT_ID
    - R2__PUBLIC_DOMAIN
    # AWS SES
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - AWS_SES_CONFIGURATION_SET
    - AWS_ENDPOINT_URL
    - AWS_ENDPOINT_URL_SES
    # Picoletter config
    - PICO_SENDING_DOMAIN
    - SEND_POST_BATCH_SIZE
    # API Keys
    - ADMIN_API_KEY
    - BILLING_API_KEY
    # Feature flags
    - ENABLE_BILLING
    - ENABLE_AUTO_REMINDERS
    - ENABLE_SCHEDULING
    # OAuth (optional)
    - GITHUB_CLIENT_ID
    - GITHUB_CLIENT_SECRET
    - GOOGLE_CLIENT_ID
    - GOOGLE_CLIENT_SECRET
  clear:
    # Rails
    RAILS_ENV: production
    RACK_ENV: production
    RAILS_LOG_TO_STDOUT: true
    RUBY_YJIT_ENABLE: true
    SOLID_QUEUE_IN_PUMA: true
    FORCE_SSL: true
    SEND_POST_BATCH_SIZE: 100
    RAILS_MAX_THREADS: 5
    WEB_CONCURRENCY: 2
    JOB_CONCURRENCY: 2
    # AWS SES
    AWS_REGION: us-east-1

# Kamal aliases for common operations
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

# Persistent storage volume for Active Storage local files and cache databases
volumes:
  - "picoletter_storage:/rails/storage"

# Bridge fingerprinted assets between versions to avoid 404s during deploys
asset_path: /rails/public/assets

# Configure the image builder
builder:
  arch: amd64
