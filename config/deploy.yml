# Kamal deployment configuration for Picoletter
# See https://kamal-deploy.org for documentation

service: picoletter
image: picoletter

# SSH configuration
ssh:
  user: deploy
  # Add your SSH key path here
  # keys:
  #   - ~/.ssh/id_rsa

# Use Kamal's built-in local registry (no external registry needed)
registry:
  server: localhost:5555

# Environment variables injected into containers
# Secrets come from .kamal/secrets.<destination>
env:
  secret:
    # Core
    - SECRET_KEY_BASE
    - DATABASE_URL
    # AWS SES
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    # Cloudflare R2 (optional)
    - R2__ACCESS_KEY
    - R2__ACCESS_SECRET
    # OAuth (optional)
    - GITHUB_CLIENT_ID
    - GITHUB_CLIENT_SECRET
    - GOOGLE_CLIENT_ID
    - GOOGLE_CLIENT_SECRET
    # API Keys
    - ADMIN_API_KEY
    - BILLING_API_KEY
    - INVITE_CODE
    # Monitoring (optional)
    - BETTERSTACK__LOGS_TOKEN
    - RORVSWILD__API_KEY
  clear:
    # Rails
    RAILS_ENV: production
    RACK_ENV: production
    RAILS_LOG_TO_STDOUT: true
    RUBY_YJIT_ENABLE: true
    # SolidQueue runs in Puma process
    SOLID_QUEUE_IN_PUMA: true

# Kamal aliases for common operations
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

# Persistent storage volume for Active Storage local files and SQLite databases
volumes:
  - "picoletter_storage:/rails/storage"

# Bridge fingerprinted assets between versions to avoid 404s during deploys
asset_path: /rails/public/assets

# Configure the image builder
builder:
  arch: amd64
