<%= render "newsletters/settings/partials/header" %>

<div class="space-y-8">
  <%= render "newsletters/settings/partials/settings_section", title: "API Token", subtitle: "Use an API token to programmatically add subscribers to your newsletter." do %>
    <% token = @newsletter.api_tokens.first %>
    <% if token %>
      <div class="max-w-lg space-y-4">
        <div class="relative" data-controller="token-visibility">
          <input type="password" value="<%= token.token %>" disabled readonly
                 autocomplete="off" data-1p-ignore data-lpignore="true" data-form-type="other"
                 class="input w-full text-sm font-mono pr-16"
                 data-token-visibility-target="input">
          <div class="absolute inset-y-0 right-0 flex items-center gap-1 pr-2">
            <button type="button" class="uppercase text-xs px-1 py-0.5 border border-stone-200 bg-white rounded-lg text-stone-600"
                    data-action="token-visibility#toggle">
              <%= lucide_icon("eye", class: "size-3 text-stone-400", data: { token_visibility_target: "showIcon" }) %>
              <%= lucide_icon("eye-off", class: "size-3 text-stone-400 hidden", data: { token_visibility_target: "hideIcon" }) %>
            </button>
            <%= button_to_copy_to_clipboard(token.token) { tag.div } %>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <%= button_to "Rotate Token", settings_api_rotate_token_path(slug: @newsletter.slug, token_id: token.id),
              method: :patch,
              class: "btn btn-secondary text-sm",
              data: { turbo_confirm: "Are you sure? This will invalidate the current token." } %>
        </div>
      </div>
    <% else %>
      <%= button_to "Generate API Token", settings_api_generate_token_path(slug: @newsletter.slug),
          method: :post,
          class: "btn btn-primary text-sm" %>
    <% end %>
  <% end %>

  <%= render "newsletters/settings/partials/settings_section", title: "API Documentation" do %>
    <div class="space-y-3 max-w-lg">
      <%= render "newsletters/settings/api/endpoint",
            title: "Add Subscriber",
            method: "POST",
            path: "/api/v1/subscribers",
            code: "curl -X POST #{request.base_url}/api/v1/subscribers \\\n  -H \"Authorization: Bearer your_api_token\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\": \"reader@example.com\", \"name\": \"Jane Doe\", \"labels\": \"vip\"}'",
            params: [
              { name: "email", required: true, description: "subscriber's email address" },
              { name: "name", required: false, description: "subscriber's full name" },
              { name: "labels", required: false, description: "comma-separated list of labels" }
            ] %>

      <%= render "newsletters/settings/api/endpoint",
            title: "Subscriber Counts",
            method: "GET",
            path: "/api/v1/subscribers/counts",
            code: "curl #{request.base_url}/api/v1/subscribers/counts \\\n  -H \"Authorization: Bearer your_api_token\"",
            response: "{\n  \"total\": 150,\n  \"verified\": 120,\n  \"unverified\": 25,\n  \"unsubscribed\": 5\n}" %>
    </div>
  <% end %>
</div>
