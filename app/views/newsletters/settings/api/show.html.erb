<%= render "newsletters/settings/partials/header" %>

<div class="space-y-8">
  <%= render "newsletters/settings/partials/settings_section", title: "API Token", subtitle: "Use an API token to programmatically add subscribers to your newsletter." do %>
    <% token = @newsletter.api_tokens.first %>
    <% if token %>
      <div class="max-w-lg space-y-4">
        <div class="relative" data-controller="token-visibility">
          <input type="password" value="<%= token.token %>" disabled readonly
                 autocomplete="off" data-1p-ignore data-lpignore="true" data-form-type="other"
                 class="input w-full text-sm font-mono pr-16"
                 data-token-visibility-target="input">
          <div class="absolute inset-y-0 right-0 flex items-center gap-1 pr-2">
            <button type="button" class="uppercase text-xs px-1 py-0.5 border border-stone-200 bg-white rounded-lg text-stone-600"
                    data-action="token-visibility#toggle">
              <%= lucide_icon("eye", class: "size-3 text-stone-400", data: { token_visibility_target: "showIcon" }) %>
              <%= lucide_icon("eye-off", class: "size-3 text-stone-400 hidden", data: { token_visibility_target: "hideIcon" }) %>
            </button>
            <%= button_to_copy_to_clipboard(token.token) { tag.div } %>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <%= button_to "Rotate Token", settings_api_rotate_token_path(slug: @newsletter.slug, token_id: token.id),
              method: :patch,
              class: "btn btn-secondary text-sm",
              data: { turbo_confirm: "Are you sure? This will invalidate the current token." } %>
        </div>
      </div>
    <% else %>
      <%= button_to "Generate API Token", settings_api_generate_token_path(slug: @newsletter.slug),
          method: :post,
          class: "btn btn-primary text-sm" %>
    <% end %>
  <% end %>

  <%= render "newsletters/settings/partials/settings_section", title: "API Documentation" do %>
    <div class="space-y-3 max-w-lg">
      <% base = request.base_url %>
      <%= render "newsletters/settings/api/endpoint",
            title: "Add Subscriber",
            method: "POST",
            path: "/api/v1/subscribers",
            samples: [
              { label: "cURL", lang: "bash", code: "curl -X POST #{base}/api/v1/subscribers \\\n  -H \"Authorization: Bearer your_api_token\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\": \"reader@example.com\", \"name\": \"Jane Doe\", \"labels\": \"vip\"}'" },
              { label: "Python", lang: "python", code: "import requests\n\nresponse = requests.post(\n    \"#{base}/api/v1/subscribers\",\n    headers={\"Authorization\": \"Bearer your_api_token\"},\n    json={\"email\": \"reader@example.com\", \"name\": \"Jane Doe\", \"labels\": \"vip\"}\n)\nprint(response.json())" },
              { label: "Ruby", lang: "ruby", code: "require \"net/http\"\nrequire \"json\"\n\nuri = URI(\"#{base}/api/v1/subscribers\")\nhttp = Net::HTTP.new(uri.host, uri.port)\nhttp.use_ssl = true\n\nrequest = Net::HTTP::Post.new(uri)\nrequest[\"Authorization\"] = \"Bearer your_api_token\"\nrequest[\"Content-Type\"] = \"application/json\"\nrequest.body = { email: \"reader@example.com\", name: \"Jane Doe\", labels: \"vip\" }.to_json\n\nresponse = http.request(request)\nputs response.body" },
              { label: "Go", lang: "go", code: "package main\n\nimport (\n\t\"bytes\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"io\"\n\t\"net/http\"\n)\n\nfunc main() {\n\tbody, _ := json.Marshal(map[string]string{\n\t\t\"email\": \"reader@example.com\",\n\t\t\"name\":  \"Jane Doe\",\n\t\t\"labels\": \"vip\",\n\t})\n\n\treq, _ := http.NewRequest(\"POST\", \"#{base}/api/v1/subscribers\", bytes.NewBuffer(body))\n\treq.Header.Set(\"Authorization\", \"Bearer your_api_token\")\n\treq.Header.Set(\"Content-Type\", \"application/json\")\n\n\tresp, _ := http.DefaultClient.Do(req)\n\tdefer resp.Body.Close()\n\tout, _ := io.ReadAll(resp.Body)\n\tfmt.Println(string(out))\n}" }
            ],
            params: [
              { name: "email", required: true, description: "subscriber's email address" },
              { name: "name", required: false, description: "subscriber's full name" },
              { name: "labels", required: false, description: "comma-separated list of labels" }
            ],
            response: "{\n  \"message\": \"Subscriber created\",\n  \"email\": \"reader@example.com\"\n}" %>

      <%= render "newsletters/settings/api/endpoint",
            title: "Subscriber Counts",
            method: "GET",
            path: "/api/v1/subscribers/counts",
            samples: [
              { label: "cURL", lang: "bash", code: "curl #{base}/api/v1/subscribers/counts \\\n  -H \"Authorization: Bearer your_api_token\"" },
              { label: "Python", lang: "python", code: "import requests\n\nresponse = requests.get(\n    \"#{base}/api/v1/subscribers/counts\",\n    headers={\"Authorization\": \"Bearer your_api_token\"}\n)\nprint(response.json())" },
              { label: "Ruby", lang: "ruby", code: "require \"net/http\"\nrequire \"json\"\n\nuri = URI(\"#{base}/api/v1/subscribers/counts\")\nrequest = Net::HTTP::Get.new(uri)\nrequest[\"Authorization\"] = \"Bearer your_api_token\"\n\nresponse = Net::HTTP.start(uri.hostname, uri.port, use_ssl: true) do |http|\n  http.request(request)\nend\nputs response.body" },
              { label: "Go", lang: "go", code: "package main\n\nimport (\n\t\"fmt\"\n\t\"io\"\n\t\"net/http\"\n)\n\nfunc main() {\n\treq, _ := http.NewRequest(\"GET\", \"#{base}/api/v1/subscribers/counts\", nil)\n\treq.Header.Set(\"Authorization\", \"Bearer your_api_token\")\n\n\tresp, _ := http.DefaultClient.Do(req)\n\tdefer resp.Body.Close()\n\tout, _ := io.ReadAll(resp.Body)\n\tfmt.Println(string(out))\n}" }
            ],
            response: "{\n  \"total\": 150,\n  \"verified\": 120,\n  \"unverified\": 25,\n  \"unsubscribed\": 5\n}" %>
    </div>
  <% end %>
</div>
