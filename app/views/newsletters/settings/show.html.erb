<%= render "newsletters/settings/partials/header" %>

<%= labeled_form_with model: @newsletter, url: settings_path(slug: @newsletter.slug), method: :patch, permission: :general do |form| %>
  <div class="max-w-lg space-y-4">
    <%= form.text_field :title,
                    required: true,
                    autofocus: true,
                    hint: "picoletter.com/#{@newsletter.slug}" %>

    <%= form.text_area :description,
                   required: true,
                   block: true,
                   rows: 5,
                   placeholder: "What is the newsletter about, write what you want your users to know",
                   hint: 'Supports <a class="underline hover:text-stone-500" target="blank" href="https://www.markdownguide.org/basic-syntax/">markdown</a>.' %>

    <%= form.select :timezone,
                TZInfo::Timezone.all_identifiers,
                {},
                hint: "Timezone in which scheduled posts will be sent." %>

    <%= form.url_field :website,
                   hint: "Website that will be linked on the archive page, in case you post these elsewhere." %>

    <label class="flex items-center gap-1">
      <%= form.check_box :enable_archive %>

      <%= form.label :enable_archive,
                 "Enable Public Archive",
                 class: "ml-px text-stone-500 text-sm font-sans" %>
    </label>

    <% if AppConfig.reminders_enabled? %>
      <label class="flex items-center gap-1">
        <%= form.check_box :auto_reminder_enabled %>

        <%= form.label :auto_reminder_enabled,
                   "Send automatic reminder to unverified subscribers",
                   class: "ml-px text-stone-500 text-sm font-sans" %>
      </label>
    <% end %>
  </div>

  <div class="mt-5">
    <%= form.submit "Update Settings", class: "btn btn-primary" %>
  </div>
<% end %>

<% if AppConfig.sub_endpoint_allowed?(@newsletter.id) %>
  <div class="mt-10 border-t py-8">
    <div class="max-w-lg text-stone-600 mb-6">
      <h3 class="font-medium text-lg text-stone-800 mb-2">API Token</h3>
      <p class="text-sm">
        Use an API token to programmatically add subscribers to your newsletter via the REST API.
      </p>
    </div>

    <% token = @newsletter.api_tokens.first %>
    <% if token %>
      <div class="max-w-lg space-y-4">
        <div class="relative" data-controller="token-visibility">
          <input type="password" value="<%= token.token %>" readonly autocomplete="off"
                 class="input w-full text-sm font-mono pr-16"
                 data-token-visibility-target="input">
          <div class="absolute inset-y-0 right-0 flex items-center gap-1 pr-2">
            <button type="button" class="uppercase text-xs px-1 py-0.5 border border-stone-200 bg-white rounded-lg text-stone-600"
                    data-action="token-visibility#toggle">
              <%= lucide_icon("eye", class: "size-3 text-stone-400", data: { token_visibility_target: "showIcon" }) %>
              <%= lucide_icon("eye-off", class: "size-3 text-stone-400 hidden", data: { token_visibility_target: "hideIcon" }) %>
            </button>
            <%= button_to_copy_to_clipboard(token.token) { tag.div } %>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <%= button_to "Rotate Token", rotate_token_settings_path(slug: @newsletter.slug, token_id: token.id),
              method: :patch,
              class: "btn btn-secondary text-sm",
              data: { turbo_confirm: "Are you sure? This will invalidate the current token." } %>
        </div>
      </div>
    <% else %>
      <%= button_to "Generate API Token", generate_token_settings_path(slug: @newsletter.slug),
          method: :post,
          class: "btn btn-primary text-sm" %>
    <% end %>
  </div>
<% end %>
