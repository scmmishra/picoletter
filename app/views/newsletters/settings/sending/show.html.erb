<%= render "newsletters/settings/partials/header" %>

<div class="space-y-8">
  <% if @newsletter.sending_domain.blank? %>
    <%# No domain connected — show connect form %>
    <%= render "newsletters/settings/partials/settings_section", title: "Connect Domain", subtitle: "Connect a custom sending domain to improve deliverability. You can also use the default domain mail.picoletter.com." do %>
      <%= form_with url: settings_sending_connect_domain_path(slug: @newsletter.slug), method: :post do |form| %>
        <div class="max-w-lg space-y-4">
          <div>
            <label for="domain" class="block text-sm font-medium text-stone-700 mb-1">Domain Name</label>
            <input type="text" name="domain" id="domain" placeholder="example.com" required
                   class="block w-full rounded-md border-stone-300 shadow-sm focus:border-stone-500 focus:ring-stone-500">
          </div>
        </div>
        <div class="mt-5">
          <%= form.submit "Connect Domain", class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>
  <% else %>
    <%# Domain exists — show sender identity first, then domain status %>

    <%# Sender Identity section %>
    <%= render "newsletters/settings/partials/settings_section", title: "Sender Identity", subtitle: "Configure the name and address that recipients see when they receive your newsletter." do %>
      <%= labeled_form_with model: @newsletter, url: settings_sending_path(slug: @newsletter.slug), method: :patch, permission: :sending do |form| %>
        <div class="max-w-lg space-y-4">
          <%= form.text_field :sending_name,
                          placeholder: "Shivam from Picoletter",
                          label: "Sending Name" %>

          <div class="space-y-1">
            <label for="newsletter_sending_local" class="ml-px text-sm text-stone-500 font-sans">Sending Address</label>
            <div class="relative">
              <input type="text" name="newsletter[sending_local]" id="newsletter_sending_local"
                     value="<%= @newsletter.sending_address&.split('@')&.first %>"
                     placeholder="updates"
                     class="input w-full"
                     style="padding-right: <%= (@newsletter.sending_domain.name.length + 1) * 0.6 + 1 %>em">
              <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4 text-stone-400">@<%= @newsletter.sending_domain.name %></span>
            </div>
          </div>

          <%= form.text_field :reply_to,
                          placeholder: "hey@picoletter.com",
                          label: "Reply To" %>
        </div>
        <div class="mt-5">
          <%= form.submit "Update Settings", class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>

    <%# Domain section %>
    <% if @newsletter.ses_verified? %>
      <%= render "newsletters/settings/partials/settings_section", title: "✅ Domain Verified", subtitle: "Your domain **#{@newsletter.sending_domain.name}** has been verified successfully." do %>
        <%= render "newsletters/settings/partials/dns_records", newsletter: @newsletter %>
        <div class="mt-5">
          <%= button_to settings_sending_disconnect_domain_path(slug: @newsletter.slug),
              method: :delete,
              class: "btn btn-outline text-red-600 hover:bg-red-50 hover:text-red-700 border-red-200 hover:border-red-300",
              data: { turbo_confirm: "Are you sure you want to disconnect this domain? Your newsletter will revert to using the default picoletter.com sending address." } do %>
            Disconnect Domain
          <% end %>
        </div>
      <% end %>
    <% else %>
      <%= render "newsletters/settings/partials/settings_section", title: "⚠️ Domain Verification Pending", subtitle: "Add the following DNS records to verify **#{@newsletter.sending_domain.name}**. It can take a couple of hours for DNS changes to propagate." do %>
        <%= labeled_form_with model: @newsletter, url: settings_sending_verify_domain_path(slug: @newsletter.slug), method: :post do |form| %>
          <%= render "newsletters/settings/partials/dns_records", newsletter: @newsletter %>
          <p class="mt-1 ml-1 font-sans text-xs text-stone-400">
            In case you're facing any trouble, you can drop us an email, and we will help you set it up.
          </p>
          <div class="mt-4 flex items-center gap-3">
            <%= form.submit "Verify DNS Records", class: "btn btn-secondary" %>
            <%= button_to settings_sending_disconnect_domain_path(slug: @newsletter.slug),
                method: :delete,
                class: "btn btn-outline text-red-600 hover:bg-red-50 hover:text-red-700 border-red-200 hover:border-red-300",
                data: { turbo_confirm: "Are you sure you want to disconnect this domain? Your newsletter will revert to using the default picoletter.com sending address." } do %>
              Disconnect Domain
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</div>
