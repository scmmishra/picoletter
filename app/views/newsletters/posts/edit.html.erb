<%= form_with model: @post, url: post_path(slug: @newsletter.slug, id: @post.id), method: :patch,
    data: {
      controller: "autosave",
      autosave_url_value: post_path(slug: @newsletter.slug, id: @post.id),
      autosave_target: "form"
    } do |form| %>
  <%= form.hidden_field :newsletter_id, value: @newsletter.id %>
  <div class="max-w-2xl mx-auto space-y-4">
    <label class="space-y-1">
      <%= form.label :title, "Subject", class: "ml-px text-stone-500 font-sans" %>
      <%= form.text_field :title,
                      required: true,
                      class: "input w-full",
                      autofocus: true,
                      data: {
                        autosave_target: "title",
                      } %>
    </label>

    <% unless @post.published? %>
      <label class="space-y-1">
        <%= form.label :cohort_id, "Send to Cohort", class: "ml-px text-stone-500 font-sans" %>
        <%= form.select :cohort_id, 
            cohort_options_for_select(@cohorts, @post.cohort_id), 
            { 
              prompt: "ðŸ“¢ All subscribers (#{@newsletter.subscribers.confirmed.count})",
              include_blank: false 
            },
            { 
              class: "input w-full",
              data: { autosave_target: "cohort" }
            } %>
        <p class="text-xs text-stone-400 ml-px">Choose a cohort to send this post to specific subscribers only</p>
      </label>
    <% else %>
      <% if @post.cohort %>
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center gap-2">
            <% if @post.cohort.emoji %>
              <span class="text-lg"><%= @post.cohort.emoji %></span>
            <% end %>
            <div>
              <p class="text-sm font-medium text-blue-900">Sent to: <%= @post.cohort.name %></p>
              <p class="text-xs text-blue-700"><%= @post.cohort.description %></p>
            </div>
          </div>
        </div>
      <% else %>
        <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
          <p class="text-sm font-medium text-green-900">Sent to: All subscribers</p>
        </div>
      <% end %>
    <% end %>
  </div>
  <div
    class="
      max-w-2xl mx-auto mt-5 prose prose-h1:text-2xl relative
      prose-headings:text-newsletter-primary prose-a:text-newsletter-primary
    "
  >
    <%= form.rich_text_area :content, data: { autosave_target: "editor" } %>
    <div
      id="auto-save-spinner"
      class="absolute animate-spin"
      style="bottom: 5px; right: 5px; display: none;"
      data-autosave-target="spinner"
    >
      <%= lucide_icon(
        "loader-circle",
        class: "size-4 transform animate-spin text-stone-400",
      ) %>
    </div>
  </div>
  <div class="flex items-end justify-between max-w-2xl gap-2 mx-auto mt-2">
    <div>
      <%= form.submit "Save Draft", class: "btn btn-primary" %>
    </div>

    <div class="flex items-center gap-2">
      <%= link_to "Send Test Email",
      send_test_post_path(slug: @newsletter.slug, id: @post.id, no_verify: true),
      class: "btn btn-secondary",
      data: {
        turbo_method: :post,
      } %>

      <% if flash[:has_link_error] %>
        <%= link_to "Publish Anyway",
        publish_post_path(slug: @newsletter.slug, id: @post.id, no_verify: true),
        class: "btn btn-warning",
        data: {
          turbo_method: :post,
          turbo_confirm:
            "Some links might be broken, ensure you have verified them. Once published the post will be sent. Are you sure you want to publish anyway?",
        } %>
      <% else %>
        <%= link_to "Publish & Send",
        publish_post_path(slug: @newsletter.slug, id: @post.id, no_verify: false),
        class: "btn btn-success",
        data: {
          turbo_method: :post,
          turbo_confirm: "Are you sure you want to publish and send this post now?",
        } %>
      <% end %>
    </div>
  </div>
<% end %>

<div class="max-w-2xl mx-auto mt-8 space-y-5">
  <% if AppConfig.get('ENABLE_SCHEDULING', true) || Current.user.super? %>
    <% if @post.scheduled? %>
      <%= render "posts/scheduled_status", post: @post %>
    <% else %>
      <%= render "posts/schedule_form", post: @post %>
    <% end %>
  <% end %>
  <%= render "posts/delete", post: @post %>
</div>
